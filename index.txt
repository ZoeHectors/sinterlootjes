<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sinterlootjes ‚Äî Familie</title>
<meta name="color-scheme" content="light">
<style>
  :root{--bg:#fff7ee;--card:#fff;--text:#1f2937;--muted:#64748b;--brand:#ef4444;--border:#e5e7eb}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-rounded,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Emoji",sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1000px;margin:24px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,.06);margin-bottom:14px}
  h1{margin:0 0 8px;font-size:24px} .lead{color:var(--muted);margin:0 0 8px}
  label{font-size:13px;font-weight:650;display:block;margin:10px 0 6px}
  input,select,textarea,button{font:inherit}
  select,input[type="password"],input[type="text"],textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  textarea{min-height:88px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px} @media (max-width:900px){.row{grid-template-columns:1fr}}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{border:none;cursor:pointer;padding:10px 12px;border-radius:10px;font-weight:650;box-shadow:0 2px 0 rgba(0,0,0,.07)}
  .btn{background:var(--brand);color:#fff} .btn-alt{background:#fff;border:1px solid var(--border)}
  .muted{color:var(--muted)} .hidden{display:none}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #fde68a;color:#92400e;border-radius:999px;padding:6px 10px;font-size:12.5px;background:#fff}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #ffe4e6;color:#9f1239;border-radius:999px;padding:6px 10px;font-size:12.5px;background:#fff}
  .inline-result{display:inline-block;margin-top:10px;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;background:linear-gradient(135deg,#fff,#fff9f1)}
  .item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed #e5e7eb;border-radius:10px;padding:10px;margin:6px 0;background:linear-gradient(135deg,#fff,#fff9f1)}
  .col{display:flex;flex-direction:column;gap:6px}
  a.inline{color:#0b3b84;text-decoration:none}
  .footnote{margin-top:8px;font-size:12px;color:#9aa3b2}
  .progress{font-size:12.5px;color:#92400e;border:1px solid #fde68a;background:#fff;border-radius:999px;padding:6px 10px;display:inline-block}
</style>
</head>
<body>
<div class="wrap">
  <!-- Header -->
  <div class="card">
    <h1>üéÖ Sinterlootjes</h1>
    <p class="lead">Kies je naam, stel/vul je wachtwoord in en bekijk jouw lootje zodra iedereen √©√©n keer is ingelogd. Verlanglijstjes voor iedereen zichtbaar ‚Äì ‚Äúik koop dit‚Äù voorkomt dubbele cadeaus.</p>
    <div class="controls">
      <span class="pill" id="loginStatus">Niet ingelogd</span>
      <span class="badge" id="allLoggedBadge">Wachten tot iedereen 1√ó ingelogd‚Ä¶</span>
    </div>
  </div>

  <!-- Login / account -->
  <div class="card">
    <h2>1) Kies je naam & wachtwoord</h2>
    <div class="row">
      <div>
        <label>Naam (uit lijst)</label>
        <select id="nameSelect"></select>
      </div>
      <div>
        <label>Wachtwoord</label>
        <input id="password" type="password" placeholder="Kies of vul je wachtwoord">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Actie</label>
        <select id="mode">
          <option value="login">Inloggen (bestaat al)</option>
          <option value="register">Nieuw aanmaken</option>
        </select>
      </div>
      <div class="controls" style="align-items:end">
        <button class="btn" id="go">Verder</button>
        <button class="btn-alt" id="logout" disabled>Uitloggen</button>
      </div>
    </div>
    <div class="footnote" id="fixedInfo"></div>
  </div>

  <!-- Lootje tonen -->
  <div class="card">
    <h2>2) Toon mijn lootje</h2>
    <p class="muted">De trekking is vast (deterministisch) op basis van de vaste deelnemers en trekcode. Je ziet alleen jouw eigen lootje wanneer <strong>iedereen 1√ó heeft ingelogd</strong>.</p>
    <div class="controls">
      <button class="btn-alt" id="reveal" disabled>Toon mijn lootje</button>
      <span id="myMatch" class="inline-result hidden"></span>
    </div>
    <div id="progressAll" class="progress hidden"></div>
  </div>

  <!-- Mijn verlanglijst -->
  <div class="card">
    <h2>Mijn verlanglijstje</h2>
    <div class="row">
      <div>
        <label>Item</label>
        <input id="itemTitle" type="text" placeholder="Wat wil je?">
      </div>
      <div>
        <label>Link (optioneel)</label>
        <input id="itemUrl" type="text" placeholder="https://...">
      </div>
    </div>
    <label>Notitie (optioneel)</label>
    <textarea id="itemNote" placeholder="Maat, kleur, voorkeur‚Ä¶"></textarea>
    <div class="controls">
      <button class="btn" id="addItem">Toevoegen</button>
    </div>
    <div id="myItems" class="col"></div>
  </div>

  <!-- Alle verlanglijstjes -->
  <div class="card">
    <h2>Alle verlanglijstjes</h2>
    <div id="allLists" class="col"></div>
  </div>

  <!-- Klein en niet wijzigbaar -->
  <div class="wrap" style="padding-top:0">
    <div class="footnote" id="fixedInfoBottom"></div>
  </div>
</div>

<!-- App -->
<script type="module">
  /* ======= VASTE INSTELLINGEN ======= */
  const EVENT_ID = 'sinty-2025';
  const TREKCODE = 'hausverlorenenbewilderd';
  const PARTICIPANTS = [
    'Dieta','Robert','Saskia S','Saskia H','Mark','Joshua','Jerome','Denise','Zo√´'
  ];

  /* === Dropdown meteen vullen (werkt ook zonder Firebase) === */
  (function initDropdown(){
    const sel = document.getElementById('nameSelect');
    if(!sel) return;
    sel.innerHTML='';
    PARTICIPANTS
      .slice()
      .sort((a,b)=>a.localeCompare(b,'nl',{sensitivity:'base'}))
      .forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
    document.getElementById('fixedInfo').textContent = `Event-ID: ${EVENT_ID} ¬∑ Trekcode: ${TREKCODE}`;
    document.getElementById('fixedInfoBottom').textContent = `Event-ID: ${EVENT_ID} ¬∑ Trekcode: ${TREKCODE}`;
  })();

  /* ======= Firebase ======= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy,
    getDocs, onSnapshot, serverTimestamp, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // JOUW (goedgekeurde) CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyDM4bGzvdMlNyr7GCTbHLEo96UJFTCYN4Y",
    authDomain: "sinterklaas-c9f01.firebaseapp.com",
    projectId: "sinterklaas-c9f01",
    storageBucket: "sinterklaas-c9f01.firebasestorage.app",
    messagingSenderId: "305941838481",
    appId: "1:305941838481:web:c5bde196d9cdda6dad5d30",
    measurementId: "G-N4Q2C0RQNK"
  };

  let app, auth, db;
  try {
    app  = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db   = getFirestore(app);
  } catch (e) {
    console.warn('Firebase nog niet geconfigureerd. Login/lijsten werken pas na juiste config.', e);
  }

  /* ======= Helpers (hash & RNG) ======= */
  const $enc = new TextEncoder();
  async function hashPass(pw, salt){
    const key  = await crypto.subtle.importKey('raw', $enc.encode(pw), {name:'PBKDF2'}, false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', hash:'SHA-256', salt:$enc.encode(salt), iterations:120000}, key, 256);
    return [...new Uint8Array(bits)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  const randSalt = () => Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2);
  const toast = m => alert(m);

  function xmur3(str){ let h=1779033703 ^ str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h ^ str.charCodeAt(i),3432918353); h=(h<<13)|(h>>>19);} return function(){ h=Math.imul(h ^ (h>>>16),2246822507); h=Math.imul(h ^ (h>>>13),3266489909); return (h^=h>>>16)>>>0;};}
  function sfc32(a,b,c,d){ return function(){ a>>>==0;b>>>==0;c>>>==0;d>>>==0; let t=(a+b)|0; a=b^(b>>>9); b=(c+(c<<3))|0; c=(c<<21)|(c>>>11); c=(c+t)|0; d=(d+1)|0; t=(t+d)|0; return (t>>>0)/4294967296;};}
  function rng(seed){ const g=xmur3(seed); return sfc32(g(),g(),g(),g()); }
  function shuffle(a, r){ const x=a.slice(); for(let i=x.length-1;i>0;i--){ const j=Math.floor(r()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; }
  function assignDeterministic(names, seed){
    const r=rng(seed), receivers=names.slice(), used=new Set(), asg=new Map();
    const givers = names.slice().sort((a,b)=>a.localeCompare(b,'nl',{sensitivity:'base'}));
    function options(g){ return receivers.filter(rv=>!used.has(rv) && rv!==g); }
    function bt(i){ if(i===givers.length) return true; const g=givers[i]; const opts=shuffle(options(g), r);
      for(const rv of opts){ used.add(rv); asg.set(g,rv); if(bt(i+1)) return true; used.delete(rv); asg.delete(g); } return false; }
    return bt(0)?asg:null;
  }

  /* ======= UI refs ======= */
  const nameSelect = document.getElementById('nameSelect');
  const passEl     = document.getElementById('password');
  const modeEl     = document.getElementById('mode');
  const goBtn      = document.getElementById('go');
  const logoutBtn  = document.getElementById('logout');
  const loginStatus= document.getElementById('loginStatus');
  const allLoggedBadge = document.getElementById('allLoggedBadge');
  const revealBtn  = document.getElementById('reveal');
  const myMatchEl  = document.getElementById('myMatch');
  const progressAll= document.getElementById('progressAll');
  const myItemsEl  = document.getElementById('myItems');
  const allListsEl = document.getElementById('allLists');

  /* ======= Auth & state ======= */
  let currentUID = null;
  let currentName = null;

  async function ensureAnon(){
    if(!auth) throw new Error('Firebase config ontbreekt');
    if(auth.currentUser) return auth.currentUser;
    const cred = await signInAnonymously(auth);
    return cred.user;
  }
  function uiUpdateAuth(u){
    loginStatus.textContent = u ? `Ingelogd (sessie) ‚Äî uid ${u.uid.slice(0,6)}‚Ä¶` : 'Niet ingelogd';
    logoutBtn.disabled = !u;
    updateRevealState().catch(()=>{});
  }
  if (auth) onAuthStateChanged(auth, uiUpdateAuth);

  async function registerOrLogin(){
    try{
      await ensureAnon();
      const name = nameSelect.value;
      const pw   = passEl.value.trim();
      if(!name || !pw) return toast('Kies je naam en voer een wachtwoord in.');
      if(!PARTICIPANTS.includes(name)) return toast('Onbekende naam.');

      const pRef = doc(db,'events',EVENT_ID,'participants',name);
      const snap = await getDoc(pRef);

      if(modeEl.value === 'register'){
        if(snap.exists()) return toast('Naam bestaat al. Kies Inloggen.');
        const salt=randSalt(); const hash=await hashPass(pw, salt);
        await setDoc(pRef, { name, pass_salt:salt, pass_hash:hash, owner_uid: auth.currentUser.uid, createdAt: serverTimestamp(), hasLoggedIn:true, lastLoginAt: serverTimestamp() });
        currentName = name;
        uiUpdateAuth(auth.currentUser);
      }else{
        if(!snap.exists()) return toast('Naam nog niet geregistreerd. Kies Nieuw aanmaken.');
        const data=snap.data(); const hash=await hashPass(pw, data.pass_salt);
        if(hash !== data.pass_hash) return toast('Onjuist wachtwoord.');
        await setDoc(pRef, { hasLoggedIn:true, lastLoginAt: serverTimestamp() }, { merge:true });
        currentName = name;
        uiUpdateAuth(auth.currentUser);
      }
      passEl.value = '';
      startMyListListener();
      refreshAllLists();
    }catch(e){ console.error(e); toast('Firebase nog niet ingesteld. Vul je config in.'); }
  }
  goBtn.addEventListener('click', registerOrLogin);
  logoutBtn.addEventListener('click', async ()=>{
    if(!auth) return;
    await signOut(auth);
    currentName=null;
    myMatchEl.classList.add('hidden'); myMatchEl.textContent='';
    uiUpdateAuth(null);
  });

  /* ======= ‚ÄúIedereen 1√ó ingelogd‚Äù ======= */
  async function computeAllLoggedOnce(){
    if(!db) return {done:0,total:PARTICIPANTS.length,all:false};
    const qs=await getDocs(collection(db,'events',EVENT_ID,'participants'));
    const map=new Map(); PARTICIPANTS.forEach(n=>map.set(n,false));
    qs.forEach(d=>{ if(map.has(d.id)){ const dat=d.data(); if(dat.hasLoggedIn===true) map.set(d.id,true); }});
    const total=PARTICIPANTS.length, done=[...map.values()].filter(Boolean).length;
    return {done,total,all:done===total};
  }
  async function updateRevealState(){
    const ok = !!(auth && auth.currentUser && currentName);
    const {done,total,all} = await computeAllLoggedOnce();
    allLoggedBadge.textContent = all ? 'Iedereen heeft 1√ó ingelogd ‚úÖ' : `Wacht op familie: ${done}/${total} heeft 1√ó ingelogd`;
    revealBtn.disabled = !(ok && all);
    if(!all){ progressAll.textContent=`Voortgang: ${done}/${total}`; progressAll.classList.remove('hidden'); }
    else{ progressAll.classList.add('hidden'); }
  }
  if (db) onSnapshot(collection(db,'events',EVENT_ID,'participants'), ()=> updateRevealState());

  /* ======= Lootje tonen ======= */
  async function revealMine(){
    if(!currentName) return toast('Log eerst in.');
    const {all} = await computeAllLoggedOnce();
    if(!all) { toast('Nog niet iedereen heeft 1√ó ingelogd.'); updateRevealState(); return; }

    const names = PARTICIPANTS.slice().sort((a,b)=>a.localeCompare(b,'nl',{sensitivity:'base'}));
    const seed  = JSON.stringify({ TREKCODE, names });
    const asg   = assignDeterministic(names, 'sinterlootjes:'+seed);
    if(!asg) return toast('Onverwacht: geen geldige trekking.');
    const target = asg.get(currentName);
    myMatchEl.textContent = `Jij koopt voor: ${target} üéÅ`;
    myMatchEl.classList.remove('hidden');
  }
  document.getElementById('reveal').addEventListener('click', revealMine);

  /* ======= Verlanglijstjes ======= */
  function itemRow(owner,id,data,purchased){
    const div=document.createElement('div'); div.className='item';
    const left=document.createElement('div'); left.className='col';
    if(data.url){ const a=document.createElement('a'); a.href=data.url; a.target='_blank'; a.textContent=data.title||'(zonder titel)'; a.className='inline'; left.appendChild(a); }
    else { const t=document.createElement('div'); t.textContent=data.title||'(zonder titel)'; left.appendChild(t); }
    if(data.note){ const s=document.createElement('div'); s.className='muted'; s.textContent=data.note; left.appendChild(s); }
    const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';

    if(owner===currentName){
      const del=document.createElement('button'); del.className='btn-alt'; del.textContent='Verwijderen';
      del.onclick=async()=>{ await deleteDoc(doc(db,'events',EVENT_ID,'wishlists',owner,'items',id)); };
      right.appendChild(del);
      // eigenaar ziet geen purchase-status
    }else{
      const btn=document.createElement('button'); btn.className='btn'; btn.textContent = purchased ? 'Gekocht (ongedaan maken)' : 'Ik koop dit';
      btn.onclick=async()=>{
        const pRef=doc(db,'events',EVENT_ID,'wishlists',owner,'purchases',id);
        if(purchased) await deleteDoc(pRef);
        else await setDoc(pRef,{ buyerUid: auth?.currentUser?.uid||'anon', buyerName: currentName||'‚Äî', at: serverTimestamp() });
      };
      right.appendChild(btn);
    }
    div.appendChild(left); div.appendChild(right);
    return div;
  }

  async function addItem(){
    if(!currentName) return toast('Log eerst in.');
    const title=document.getElementById('itemTitle').value.trim();
    const url=document.getElementById('itemUrl').value.trim();
    const note=document.getElementById('itemNote').value.trim();
    if(!title) return toast('Geef een titel.');
    await addDoc(collection(db,'events',EVENT_ID,'wishlists',currentName,'items'), { title, url:url||null, note:note||null, createdAt: serverTimestamp() });
    document.getElementById('itemTitle').value=''; document.getElementById('itemUrl').value=''; document.getElementById('itemNote').value='';
  }
  document.getElementById('addItem').addEventListener('click', addItem);

  function startMyListListener(){
    if(!db || !currentName){ myItemsEl.innerHTML=''; return; }
    const qItems=query(collection(db,'events',EVENT_ID,'wishlists',currentName,'items'), orderBy('createdAt','asc'));
    onSnapshot(qItems,(snap)=>{
      myItemsEl.innerHTML=''; snap.forEach(d=>{ myItemsEl.appendChild(itemRow(currentName,d.id,d.data(),false)); });
      if(!snap.size){ myItemsEl.innerHTML='<div class="muted">Nog geen items.</div>'; }
    });
  }

  async function refreshAllLists(){
    if(!db){ allListsEl.innerHTML='<div class="muted">Firebase nog niet ingesteld.</div>'; return; }
    allListsEl.innerHTML='';
    const owners = PARTICIPANTS.slice().sort((a,b)=>a.localeCompare(b,'nl',{sensitivity:'base'}));
    for(const owner of owners){
      const wrap=document.createElement('div'); wrap.className='card';
      const h=document.createElement('h3'); h.textContent=owner; wrap.appendChild(h);
      const list=document.createElement('div'); list.className='col'; wrap.appendChild(list);
      allListsEl.appendChild(wrap);

      const qItems=query(collection(db,'events',EVENT_ID,'wishlists',owner,'items'), orderBy('createdAt','asc'));
      const iSnap=await getDocs(qItems);

      let purchasedIds=new Set();
      try{ const pSnap=await getDocs(collection(db,'events',EVENT_ID,'wishlists',owner,'purchases')); pSnap.forEach(d=>purchasedIds.add(d.id)); }
      catch(_){ purchasedIds=new Set(); } // eigenaar: geen leesrechten

      iSnap.forEach(d=>{
        const isPurchased=purchasedIds.has(d.id);
        if(owner !== currentName && isPurchased) return; // verberg gekochte items voor anderen
        list.appendChild(itemRow(owner,d.id,d.data(),isPurchased));
      });
      if(!list.childElementCount){ const em=document.createElement('div'); em.className='muted'; em.textContent='Geen zichtbare items.'; list.appendChild(em); }
    }
  }

  if (db) {
    onSnapshot(collection(db,'events',EVENT_ID,'participants'), ()=>{ updateRevealState(); startMyListListener(); refreshAllLists(); });
    onSnapshot(collection(db,'events',EVENT_ID,'wishlists'), ()=> refreshAllLists());
  }
  // eerste render
  startMyListListener(); refreshAllLists();
</script>
</body>
</html>